// Class automatically generated by Dev-C++ New Class wizard

#include "analizador.h" // class's header file

// class constructor
Analizador::Analizador() {                 
    
    ogroup_ana = new Fl_Group(5,370,500,330,"");
    ogroup_ana->box(FL_ENGRAVED_FRAME);
    ogroup_ana->box(FL_UP_BOX);
    ogroup_ana->deactivate();  
   
    apantalla_ch1 = new Fl_Scope(12,375,380,34,"");  // Instancia de canal 1
    apantalla_ch2 = new Fl_Scope(12,407,380,34,"");  // Instancia de canal 2
    apantalla_ch3 = new Fl_Scope(12,439,380,34,"");  // Instancia de canal 3
    apantalla_ch4 = new Fl_Scope(12,471,380,34,"");  // Instancia de canal 4
    apantalla_ch5 = new Fl_Scope(12,503,380,34,"");  // Instancia de canal 5
    apantalla_ch6 = new Fl_Scope(12,535,380,34,"");  // Instancia de canal 6
    apantalla_ch7 = new Fl_Scope(12,567,380,34,"");  // Instancia de canal 7
    apantalla_ch8 = new Fl_Scope(12,599,380,34,"");  // Instancia de canal 8
    
    odato1 = new Fl_Output(16,638,36,20,"");
    odato1->textsize(9);
    odato2 = new Fl_Output(54,638,36,20,"");
    odato3 = new Fl_Output(90,638,36,20,"");
    odato4 = new Fl_Output(127,638,36,20,"");
    odato5 = new Fl_Output(164,638,36,20,"");
    odato6 = new Fl_Output(201,638,36,20,"");
    odato7 = new Fl_Output(238,638,36,20,"");
    odato8 = new Fl_Output(275,638,36,20,"");
    odato9 = new Fl_Output(312,638,36,20,"");
    odato10 = new Fl_Output(349,638,36,20,"");
    
    olog_ana = new Fl_Button(60,660,40,16,"Log");
    olog_ana->labelsize(10);
    
    ohelp_ana = new Fl_Button(60,678,40,16,"Help");
    ohelp_ana->labelsize(10);
    
    oayuda_ana = new Fl_Check_Button(110,678,20,16,"?");
    oayuda_ana->labelsize(12);
    
    apantalla_ch1->TraceColour(FL_RED);
    apantalla_ch1->tracetype(FL_SCOPE_TRACE_LOOP);
    apantalla_ch1->redrawmode(FL_SCOPE_REDRAW_ALWAYS);
    apantalla_ch1->linetype(FL_SCOPE_LINE);
    apantalla_ch2->TraceColour(FL_RED);
    apantalla_ch2->tracetype(FL_SCOPE_TRACE_LOOP);
    apantalla_ch2->redrawmode(FL_SCOPE_REDRAW_ALWAYS);
    apantalla_ch2->linetype(FL_SCOPE_LINE);
    apantalla_ch3->TraceColour(FL_RED);
    apantalla_ch3->tracetype(FL_SCOPE_TRACE_LOOP);
    apantalla_ch3->redrawmode(FL_SCOPE_REDRAW_ALWAYS);
    apantalla_ch3->linetype(FL_SCOPE_LINE);
    apantalla_ch4->TraceColour(FL_RED);
    apantalla_ch4->tracetype(FL_SCOPE_TRACE_LOOP);
    apantalla_ch4->redrawmode(FL_SCOPE_REDRAW_ALWAYS);
    apantalla_ch4->linetype(FL_SCOPE_LINE);
    apantalla_ch5->TraceColour(FL_RED);
    apantalla_ch5->tracetype(FL_SCOPE_TRACE_LOOP);
    apantalla_ch5->redrawmode(FL_SCOPE_REDRAW_ALWAYS);
    apantalla_ch5->linetype(FL_SCOPE_LINE);
    apantalla_ch6->TraceColour(FL_RED);
    apantalla_ch6->tracetype(FL_SCOPE_TRACE_LOOP);
    apantalla_ch6->redrawmode(FL_SCOPE_REDRAW_ALWAYS);
    apantalla_ch6->linetype(FL_SCOPE_LINE);
    apantalla_ch7->TraceColour(FL_RED);
    apantalla_ch7->tracetype(FL_SCOPE_TRACE_LOOP);
    apantalla_ch7->redrawmode(FL_SCOPE_REDRAW_ALWAYS);
    apantalla_ch7->linetype(FL_SCOPE_LINE);
    apantalla_ch8->TraceColour(FL_RED);
    apantalla_ch8->tracetype(FL_SCOPE_TRACE_LOOP);
    apantalla_ch8->redrawmode(FL_SCOPE_REDRAW_ALWAYS);
    apantalla_ch8->linetype(FL_SCOPE_LINE);
            
    ogroup_ana_botones = new Fl_Group(400,375,95,250,"");  // Agrupa los elementos del analizador
    ogroup_ana_botones->box(FL_ENGRAVED_FRAME); 
    ogroup_ana_botones->deactivate();
    
    omuestreo = new Fl_Value_Slider(420,390,30,220,"");
    omuestreo->range(1,10);
    omuestreo->step(1);
    omuestreo->round(1); 
    
    ogroup_ana_botones->end();
    
    orep_dato = new Fl_Choice(398,638,100,20,"");
    orep_dato->add("Decimal");
    orep_dato->add("Binario");
    orep_dato->add("Hexadecimal");
    //orep_dato->labelsize(10);
    //orep_dato->align(FL_ALIGN_TOP);
    
        
    ogroup_ana->end();
    oana_on = new Fl_Light_Button(15,662,38,30,"ON");
    oana_on->labelsize(9);
    
    oana_on->callback(cb_ana_on, this);
}

// class destructor
Analizador::~Analizador() {

}
/**
 * Este callback es llamado cuando se inicializa el analizador
 * logico.
*/
void Analizador::cb_ana_on(Fl_Widget* pboton, void *pany) {
     Analizador* pana=(Analizador*)pany;
     pana->cb_ana_on_in();
}

/**
 * Esta es la funcion inline que es llamada desde el callback
 * cb_ana_on.
*/
void Analizador::cb_ana_on_in() {
      if(oana_on->value()== 1) {
        activar(1);
        Encapsular('C','a','1','0',0x00,0x00);
        Transmision();
        if (bhardware){
           ogroup_ana->activate();
           ogroup_ana_botones->activate();
           Fl::add_timeout(0.5, cb_timer_ana, this);
        }
        else {
             fl_message("Error de hardware");
        }
     }
     if(oana_on->value()== 0) {
        Fl::remove_timeout(cb_timer_ana, this);
        activar(0);
        ogroup_ana->deactivate();
        ogroup_ana_botones->deactivate(); 
     }
}

/**
 * Este método es el callback del timer para realizar la solicitud 
 * de datos del analizador al hardware.  
*/
void Analizador::cb_timer_ana(void *pany) {
     Analizador* pana=(Analizador*)pany;
     pana->cb_timer_ana_in();
}

/**
 * Esta función acompaña la función cb_timer_ana
 * para realizar los llamados de callback del timer 
*/
void Analizador::cb_timer_ana_in() {
     Encapsular('C','p','1','0',0x00,0x00);
     Transmision();
     separar_canales();
     Fl::repeat_timeout(1, cb_timer_ana, this);
}


/**
 * Esta funcion separa los datos enviados desde el hardware para cada
 * canal del analizador logico.
*/
void Analizador::separar_canales() {
     int ilong;
     int ipos_msb;
     int ipos_lsb;
     char cdato_1[9];
     
     if (buf_analizador[0] > 64){
        ipos_msb = int(buf_analizador[0]-55);
     }
     else{
         ipos_msb = int(buf_analizador[0]-48); 
     }
     if (buf_analizador[1] > 64){
        ipos_lsb = int(buf_analizador[1]-55);
     }
     else{
         ipos_lsb = int(buf_analizador[1]-48); 
     }
     //fl_message("entero es %d", atoi(buf_analizador));
     itoa(atoi(buf_analizador),cdato_1,10);                  //convertir el dato a caracter para colocarlo en el cuadro de la rep del dato
     odato1->value(cdato_1);
     itoa(ipos_msb,recibido_msb,2);
     ilong = strlen(recibido_msb);
     for (int i= 4; i > 0; i-- ){
         if (ilong > 0){
            recibido_msb2[i-1] = recibido_msb[ilong-1];
         }
         else {
              recibido_msb2[i-1] = '0';
         }
         ilong --;
     }
     itoa(ipos_lsb,recibido_lsb,2);
     ilong = strlen(recibido_lsb);
     for (int i= 4; i > 0; i-- ){
         if (ilong > 0){
            recibido_lsb2[i-1] = recibido_lsb[ilong-1]; 
         }
         else {
              recibido_lsb2[i-1] = '0';
         }
         ilong --;
     }
     strcat(recibido_msb2,recibido_lsb2);
     //Canal 1
     if (recibido_msb2[0]=='1'){
        for (int i=0; i<38;i++){                   
            apantalla_ch1->Add(50000);
        }
     }
     else if (recibido_msb2[0]=='0'){
          for (int i=0; i<38;i++){                   
              apantalla_ch1->Add(10000);
          }
     }
     //Canal 2
     if (recibido_msb2[1]=='1'){
        for (int i=0; i<38;i++){                   
            apantalla_ch2->Add(50000);
        }
     }
     else if (recibido_msb2[1]=='0'){
          for (int i=0; i<38;i++){                   
              apantalla_ch2->Add(10000);
          }
     }
     //Canal 3
     if (recibido_msb2[2]=='1'){
        for (int i=0; i<38;i++){                   
            apantalla_ch3->Add(50000);
        }
     }
     else if (recibido_msb2[2]=='0'){
          for (int i=0; i<38;i++){                   
              apantalla_ch3->Add(10000);
          }
     }
     //Canal 4
     if (recibido_msb2[3]=='1'){
        for (int i=0; i<38;i++){                   
            apantalla_ch4->Add(50000);
        }
     }
     else if (recibido_msb2[3]=='0'){
          for (int i=0; i<38;i++){                   
              apantalla_ch4->Add(10000);
          }
     }
     //Canal 5
     if (recibido_msb2[4]=='1'){
        for (int i=0; i<38;i++){                   
            apantalla_ch5->Add(50000);
        }
     }
     else if (recibido_msb2[4]=='0'){
          for (int i=0; i<38;i++){                   
              apantalla_ch5->Add(10000);
          }
     }
     //Canal 6
     if (recibido_msb2[5]=='1'){
        for (int i=0; i<38;i++){                   
            apantalla_ch6->Add(50000);
        }
     }
     else if (recibido_msb2[5]=='0'){
          for (int i=0; i<38;i++){                   
              apantalla_ch6->Add(10000);
          }
     }
     //Canal 7
     if (recibido_msb2[6]=='1'){
        for (int i=0; i<38;i++){                   
            apantalla_ch7->Add(50000);
        }
     }
     else if (recibido_msb2[6]=='0'){
          for (int i=0; i<38;i++){                   
              apantalla_ch7->Add(10000);
          }
     }
     //Canal 8
     if (recibido_msb2[7]=='1'){
        for (int i=0; i<38;i++){                   
            apantalla_ch8->Add(50000);
        }
     }
     else if (recibido_msb2[7]=='0'){
          for (int i=0; i<38;i++){                   
              apantalla_ch8->Add(10000);
          }
     } 
}



/**
 * Funcion para recorrer los buffers y graficar la informacion
*/
void Analizador::graficar_datos() {
/* TODO: hacer */
}
